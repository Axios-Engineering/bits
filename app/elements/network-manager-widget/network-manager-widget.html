<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../base-layout/base-single-grid-item-wrapper/base-single-grid-item-wrapper.html">
<link rel="import" href="../network-manager-app/network-manager-shared-styles.html">
<link rel="import" href="../network-manager-connections/network-manager-connections.html">
<link rel="import" href="../network-manager-devices/network-manager-devices.html">

<dom-module id="network-manager-widget">
  <template>
    <style include="network-manager-shared-styles">
    .line-title {
      display: block;
      text-align: center;
    }

    .item-name {
      flex: 0 0 105px;
    }

    .item-type {
      flex: 0 0 90px;
    }

    @media (max-width: 1100px) {
      .item-type {
        @apply --layout-flex;
      }
    }

    @media (max-width: 1024px) {
      .item-type {
        flex: 0 0 120px;
      }
    }

    @media (max-width: 840px) {
      .item-type {
        @apply --layout-flex;
      }
    }

    @media (max-width: 480px) {
      .item-device {
        @apply --layout-flex;
      }
    }
    </style>

    <network-manager-connections
      id="connections"
      items="{{connections}}">
    </network-manager-connections>

    <network-manager-devices
      items="{{devices}}">
    </network-manager-devices>

    <div class="content">
      <base-single-grid-item-wrapper>
        <span class="line-title">Active Connections</span>
        <div class="line line-header">
          <span class="item item-name">Name</span>
          <span class="item item-type hide-below-480">Type</span>
        </div>
        <template is="dom-repeat" items="[[items]]">
          <div class$="line active-[[item.active]]">
            <span class="item item-name">[[item.name]]</span>
            <span class="item item-type hide-below-480">[[item.type]]</span>
          </div>
        </template>
      </base-single-grid-item-wrapper>
    </div>

  </template>
  <script>
    ((global) => {
      'use strict';

      function sortByActiveAndConnectionId(itemA, itemB) {
        if (itemA.active && itemB.active) {
          return sortByConnectionId(itemA, itemB);
        } else if (itemA.active) {
          return -1;
        } else if (itemB.active) {
          return 1;
        } else {
          return sortByConnectionId(itemA, itemB);
        }
      }

      function sortByConnectionId(itemA, itemB) {
        const idA = itemA.connection.id.toUpperCase();
        const idB = itemB.connection.id.toUpperCase();

        if (idA < idB) {
          return -1;
        }
        if (idA > idB) {
          return 1;
        }
        return 0;
      }

      Polymer({
        is: 'network-manager-widget',

        properties: {
          items: {
            type: Array,
            value: Array.from([]),
            readOnly: true
          },
          stateList: {
            type: Array,
            value: Array.from([])
          }
        },

        __setItems: function() {
          let items = [];

          if (Array.isArray(this.connections)) {
            const supported = this.$.connections.getTypes();
            const supportedKeys = Object.keys(supported);
            const supportedVals = supportedKeys.map((key) => supported[key]);

            let appliedConnections = [];
            if (Array.isArray(this.devices)) {
              appliedConnections = this.devices.filter((device) => device.AppliedConnection.length > 0).map((device) => device.AppliedConnection[0]);
            }

            items = this.connections.filter((item) => supportedVals.includes(item.connection.type))
              .map((item) => Object.assign(item, {active: appliedConnections.some((appliedConnection) => appliedConnection.connection.uuid === item.connection.uuid)}));
            items.sort(sortByActiveAndConnectionId);


            items = items.filter((item) => item.active)
            .map((item) => {
              return {
                id: item.id,
                name: item.connection.id,
                uuid: item.connection.uuid,
                type: item.connection.type,
                active: item.active,
              };
            });
          }

          this._setItems(items);
        },

        _observeConnectionsAndDevices: function() {
          this.__setItems();
          this.refreshLayout();
        },

        _computeHidden: function() {
          return Array.isArray(this.connections) && this.connections.length < 1;
        },

        _observeHidden: function() {
          this.toggleClass('hidden', this.hidden, Polymer.dom(this).node);
          this.refreshLayout();
        },

        refreshLayout: function() {
          this.async(() => this.fire('base-dashboard-refresh-layout'), 150);
        },

        observers: [
          '_observeConnectionsAndDevices(connections.*, devices.*)'
        ]
      });
    })(this);
  </script>
</dom-module>
