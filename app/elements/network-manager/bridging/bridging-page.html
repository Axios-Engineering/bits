<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../../bower_components/font-roboto/roboto.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../base-system/base-system.html">

<link rel="import" href="./bridge-config-card.html">
<link rel="import" href="./bridge-configs.html">

<dom-module id="bridge-page">
  <template>
    <style include="app-grid-style">
      :host{
        display: block;
        padding: 8px 8px 8px 8px;
        --app-grid-columns: 1;
        --app-grid-item-height: 525px;
        --app-grid-gutter: 8px;
      }

      #header {
        position: absolute;
        border-bottom: 1px solid lightgrey;
      }

      .app-grid {
        height: 100%;
        width: 100%;
        overflow-y: auto;
      }

      .toast-action {
        float: right;
        color:  white;
      }

      #toastSuccess {
        --paper-toast-color: lightblue;
      }

      #toastError {
        --paper-toast-color: orangered;
      }

      @media screen and (min-width: 930px) {
        :host {
          --app-grid-columns: 2;
        }
      }

      @media screen and (min-width: 1400px) {
        :host {
          --app-grid-columns: 3;
        }
      }

    </style>

    <!--Message center communication and data from the server-->
    <bridge-configs id="configs" items="{{configs}}"></bridge-configs>
    <base-system id="system"></base-system>

    <app-header-layout has-scrolling-region fullbleed>
      <app-header id="header">
        <app-toolbar>
          <div main-title>Bridge Configuration</div>
        </app-toolbar>
      </app-header>

      <div class="app-grid" id="bridgeGrid">
        <template is="dom-repeat" items="{{configs}}" as="config">
          <bridge-config-card class="interface" config="{{config}}" bits-id="[[bitsId]]"></bridge-config-card>
        </template>
      </div>

    </app-header-layout>

    <paper-toast text="Success: changes applied." id="toastSuccess">
      <span class="toast-action" on-tap="_dismissSuccessToast">Dismiss</span>
    </paper-toast>

    <paper-toast text="Error! bridge error!" id="toastError">
      <span class="toast-action" on-tap="_dismissErrorToast">Dismiss</span>
    </paper-toast>

  </template>

  <script>
    ((global) => {
      'use strict';

      const TAG = 'NETWORK_MGR:BRIDGE:CONFIG_APP';
      const debug = window.Bits.utils.getDebugger(TAG);


      //For determining if we are making changes remotely
      const LOCALHOST_REGEX = new RegExp(/localhost/);
      const LOCALHOST_ADDR = new RegExp(/127\.0\.0\.1/);

      const TOAST_DURATION_LONG = 5000;
      const TOAST_DURATION_SHORT = 2000;

      Polymer({

        is: 'bridge-page',

        behaviors: [
          Polymer.IronResizableBehavior
        ],

        listeners: {
          'save-bridge-config': '_onSave',
        },

        properties: {
          bitsId: {
            type: Object,
            notifies: true
          }
        },

        ready: function() {
          this.$.system.getBitsId()
          .then((bitsId) => {
            this.bitsId = bitsId;
          })
          .catch((err) => {
            console.error('Could not get bits id');
          });
        },

        _isConnectionLocal: function(){
          debug('_isConnectionLocal', window.location.hostname);
          return LOCALHOST_ADDR.test(window.location.hostname) || LOCALHOST_REGEX.test(window.location.hostname);
        },

        /**
         * Event handler for when a user clicks apply on a specific configuration card.
         */
        _onSave: function(e, bridgeConfig){
          // Save if we don't have any validation errors and not remotely editing
          this.$.configs.update(bridgeConfig)
            .then(() => {
              // TODO some day we might want to show the message
              this._showSuccessToast(null, TOAST_DURATION_SHORT);
            })
            .catch(() => {
              // TODO some day we might want to show the error
              this._showErrorToast(null, TOAST_DURATION_LONG);
            });
        },

        _showSuccessToast(message, duration) {
          const properties = {
            duration: duration,
          };

          if(message) {
            properties.text = message;
          }

          this.$.toastSuccess.show(properties);
        },

        _showErrorToast(message, duration) {
          const properties = {
            duration: duration,
          };

          if(message) {
            properties.text = message;
          }

          this.$.toastError.show(properties);
        },

        _dismissErrorToast: function(e) {
          this.$.toastError.close();
        },

        _dismissSuccessToast: function(e) {
          this.$.toastSuccess.close();
        }

      }); // End polymer

    })(this);
  </script>

</dom-module>
