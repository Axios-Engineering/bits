<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../base-message-center/base-message-center-behavior.html">

<script>
  ((global) => {
    'use strict';

    const API_KEY = 'networkManager#wifi#';

    function generateEventString(eventName) {
      return API_KEY + eventName;
    }

    const EVENTS = {
      UPDATE_CONFIGS: generateEventString('update-configs'),
      GET_CONFIGS: generateEventString('get-configs'),
      APPLY: generateEventString('apply'),
      SCAN: generateEventString('scan'),
      GET_BITS_ID: generateEventString('get-bits-id')
  };

    Polymer({
      is: 'wifi-configs',

      behaviors: [
        /** @polymerBehavior BaseMessageCenterBehavior */
        global.Bits.BaseMessageCenterBehavior
      ],

      properties: {
        configs: {
          type: Array,
          notify: true,
        },

        scans: {
          type: Array,
          readOnly: true,
          notify: true,
        },

        bitsId: {
          type: String,
          readOnly: true,
          notify: true
        },
      },

      ready: function() {
        // Setup a listener so the server can push us device changes without us requesting
        return this.addSocketEventListener(EVENTS.UPDATE_CONFIGS, this._onConfigs.bind(this))
          .then(() => this.addConnectRunnable(this.getBitsId.bind(this)))
          .then(() => this.addConnectRunnable(this.getConfigs.bind(this)));
      },

      _onConfigs: function(configs) {
        this.configs = configs;
      },

      getBitsId: function() {
        return this.sendRequest(EVENTS.GET_BITS_ID)
          .then((bitsId) => this._setBitsId(bitsId))
          .catch((err) => console.error(err));
      },

      getConfigs: function() {
        return this.sendRequest(EVENTS.GET_CONFIGS)
        .then((configs) => this.set('configs', configs));
      },

      save: function(deviceConfiguration) {
        return this.sendRequest(EVENTS.APPLY, deviceConfiguration)
      },

      scan(deviceName) {
        return this.sendRequest(EVENTS.SCAN, deviceName)
          .then((scans) => scans.filter(scan => scan.ssid !== null))
          .then((scans) => this._setScans(scans))
      }
    });
  })(this);
</script>
