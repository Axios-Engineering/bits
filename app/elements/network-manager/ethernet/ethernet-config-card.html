<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- Iron Elements -->
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">

<!-- Paper Elements -->
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">

<!--network-manager-->
<link rel="import" href="./ipv4-addr-validator.html">

<dom-module id="ethernet-config-card">

  <template>

    <style>

      :host{
        display: block;
      }

      .interfaceToolbar {
        --paper-toolbar-background: white;
        --paper-toolbar-color: --dark-theme-text-color;
      }

      paper-toolbar.interfaceToolbar > ::content .title{
        margin-left: 8px;
      }

      .container {
        margin-bottom: 2%;
        margin-left: 10%;
        margin-right: 10%;
      }

      .selections {
        margin: 0 auto;
        border-bottom: 1px solid grey;
        border-top: 1px solid grey;
      }

      .actions {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        padding: 8px 36px 16px 36px;
      }

      paper-card {
        width: 100%;
        height: 100%;
      }

      paper-radio-group {
        padding: 4px 8px 0px 8px;
      }


    </style>

    <paper-card>

      <!--Header for each interface-->
      <paper-toolbar class="interfaceToolbar">
        <div class="title">
          <iron-icon icon="hardware:developer-board"></iron-icon>
          <span>[[config.name]]</span>
        </div>
      </paper-toolbar>

      <!--Config for this interface-->
      <div class="container">
        <div class="selections">
          <paper-radio-group selected="{{selectedMode}}" id="mode">
            <paper-radio-button name="none">Inactive</paper-radio-button>
            <paper-radio-button name="dhcp">DHCP</paper-radio-button>
            <paper-radio-button name="static">Static</paper-radio-button>
            <paper-radio-button name="shared">Shared</paper-radio-button>
            <paper-radio-button name="bridge">Bridge</paper-radio-button>
          </paper-radio-group>
        </div>

        <div class="inputs">
          <ipv4-addr-validator validator-name="ipv4"></ipv4-addr-validator>
          <ipv4-addr-validator is-for-dns validator-name="dns"></ipv4-addr-validator>
          <paper-input id="ip"
                       label="IP Address"
                       value="{{selectedAddress}}"
                       disabled="{{isInputDisabled}}"
                       auto-validate
                       validator="ipv4"
                       error-message="Only non-reserved IPv4 addresses allowed"
                       invalid="{{isIPInvalid}}">
          </paper-input>
          <paper-input id="subnet"
                       label="Subnet Mask"
                       value="{{selectedSubnet}}"
                       disabled="{{isInputDisabled}}"
                       auto-validate
                       validator="ipv4"
                       error-message="Only non-reserved IPv4 Netmasks allowed"
                       invalid="{{isSubnetInvalid}}">
          </paper-input>

          <paper-input id="gateway"
                       label="Gateway"
                       value="{{selectedGateway}}"
                       disabled="{{isInputDisabledStatic}}"
                       auto-validate
                       validator="ipv4"
                       error-message="Only non-reserved IPv4 addresses allowed"
                       invalid="{{isGatewayInvalid}}">
          </paper-input>

          <paper-input id="dnsOne"
                       label="DNS 1"
                       value="{{selectedDnsOne}}"
                       disabled="{{isInputDisabledStatic}}"
                       auto-validate
                       validator="dns"
                       error-message="Only non-reserved IPv4 addresses allowed"
                       invalid="{{isDNS1Invalid}}">
          </paper-input>

          <paper-input id="dnsTwo"
                       label="DNS 2"
                       value="{{selectedDnsTwo}}"
                       disabled="{{isInputDisabledStatic}}"
                       auto-validate
                       validator="dns"
                       error-message="Only non-reserved IPv4 addresses allowed"
                       invalid="{{isDNS2Invalid}}">
          </paper-input>
        </div>

      </div>

      <div class="actions">
        <paper-icon-button disabled="{{!isChange}}" icon="icons:clear" on-tap="clear"></paper-icon-button>
        <paper-icon-button disabled="{{isApplyDisabled}}" icon="icons:save" on-tap="save"></paper-icon-button>
      </div>

    </paper-card>

  </template>

  <script src="/elements/network-manager/scripts/bundle.js"></script>
  <script>
    (() => {
      'use strict';

      const TAG = 'NETWORK_MGR:ETHERNET:CONFIG_CARD';
      const debug = window.Bits.utils.getDebugger(TAG);

      const MODES = {
        BRIDGE: 'bridge',
        DHCP: 'dhcp',
        STATIC: 'static',
        SHARED: 'shared',
        NONE: 'none' // Indicates disconnected but we don't want to support this right now
      };

      const DEFAULTS = {
        AUTO_CONNECT: true,
        MODE: MODES.NONE,
        ADDRESS: null,
        SUBNET: null,
        DNS_ONE: null,
        DNS_TWO: null,
        GATEWAY: null
      };

      Polymer({

        is: 'ethernet-config-card',

        // From the server
        properties: {
          config: {
            type: Object,
            notify: true,
            observer: '_observeConfig'
          },

          isInputDisabled: {
            type: Boolean,
            computed: '_computeIsInputDisabled(selectedMode)'
          },

          isInputDisabledStatic: {
            type: Boolean,
            computed: '_computeIsInputDisabledStatic(selectedMode)'
          },

          selectedMode: {
            type: String,
            value: function() {
              return DEFAULTS.MODE;
            },
            observer: '_observeSelectedMode'
          },

          selectedAddress: {
            type: String,
            value: function() {
              return DEFAULTS.ADDRESS;
            },
            observer: '_observeSelectedAddress'
          },

          selectedSubnet: {
            type: String,
            value: function() {
              return DEFAULTS.SUBNET;
            },
            observer: '_observeSelectedSubnet'
          },

          selectedDnsOne: {
            type: String,
            value: function() {
              return DEFAULTS.DNS_ONE;
            },
            observer: '_observeSelectedDnsOne'
          },

          selectedDnsTwo: {
            type: String,
            value: function() {
              return DEFAULTS.DNS_TWO;
            },
            observer: '_observeSelectedDnsTwo'
          },

          selectedGateway: {
            type: String,
            value: function() {
              return DEFAULTS.GATEWAY;
            },
            observer: '_observeSelectedGateway'
          },

          isIPInvalid: {
            type: Boolean,
            value: function() {
              return false;
            }
          },

          isSubnetInvalid: {
            type: Boolean,
            value: function() {
              return false;
            }
          },

          isGatewayInvalid: {
            type: Boolean,
            value: function() {
              return false;
            }
          },

          isDNS1Invalid: {
            type: Boolean,
            value: function() {
              return false;
            }
          },

          isDNS2Invalid: {
            type: Boolean,
            value: function() {
              return false;
            }
          },

          isFormInvalid: {
            type: Boolean,
            computed: '_computeIsFormInvalid(isIPInvalid, isSubnetInvalid, isGatewayInvalid, isDNS1Invalid, isDNS2Invalid)'
          },

          isChange: {
            type: Boolean,
            value: false
          },

          isApplyDisabled: {
            type: Boolean,
            computed: '_computeIsApplyDisabled(isFormInvalid, isChange)'
          }

        },

        _isNull(ref) {
          return (ref === undefined || ref === null);
        },

        _isAnyNull(refArray) {
          return refArray.some(ref => this._isNull(ref));
        },

        _computeIsFormInvalid: function(isIPInvalid, isSubnetInvalid, isGatewayInvalid, isDNS1Invalid, isDNS2Invalid) {
          if (this._isAnyNull([isIPInvalid, isSubnetInvalid, isGatewayInvalid, isDNS1Invalid, isDNS2Invalid])) {
            // If any param is undefined then we want to make sure the form is valid since we are probably loading
            return false;
          }

          return isIPInvalid || isSubnetInvalid || isGatewayInvalid || isDNS1Invalid || isDNS2Invalid;
        },

        _computeIsApplyDisabled: function(isFormInvalid, isChange) {
          if (this._isAnyNull([isFormInvalid, isChange])) {
            // If we don't have all our properties we allow save to be disabled.
            return false;
          }

          return isFormInvalid || !isChange;
        },

        _handleChange: function() {
          debug('_handleChange', this.config.name);
          this.set('isChange', true);
        },

        _initialize: function(config) {
          if (!this._isNull(config.mode)) {
            this.set('selectedMode', config.mode);
          } else {
            console.error('Unable to set config. Mode is null.');
          }

          if (!this._isNull(config.address)) {
            this.set('selectedAddress', config.address);
          }

          if (!this._isNull(config.subnet)) {
            this.set('selectedSubnet', config.subnet);
          }

          if (!this._isNull(config.dnsOne)) {
            this.set('selectedDnsOne', config.dnsOne);
          }

          if (!this._isNull(config.dnsTwo)) {
            this.set('selectedDnsTwo', config.dnsTwo);
          }

          if (!this._isNull(config.gateway)) {
            this.set('selectedGateway', config.gateway);
          }
        },

        _observeConfig: function(newVal, oldVal) {
          debug('_observeConfig', newVal, oldVal);
          if (oldVal === undefined) {
            // When we first load we want to set the bound values in the UI to match our new config
            // NOTE: We don't set the isChange here since that is initialized to false by definition
            this._initialize(newVal);
          }
        },

        _observeSelectedMode: function(newVal, oldVal) {
          debug('_observeSelectedMode', newVal, oldVal);
          if (oldVal === null || oldVal === undefined) {
            // Ignore the initialization step
            return;
          }

          // Handle actual changes not part of initialization
          this._handleChange();
        },

        _observeSelectedAddress: function(newVal, oldVal) {
          debug('selectedAddress', newVal, oldVal);
          if (oldVal === null || oldVal === undefined) {
            // Ignore the initialization step
            return;
          }

          // Handle actual changes not part of initialization
          this._handleChange();
        },

        _observeSelectedSubnet: function(newVal, oldVal) {
          if (oldVal === null || oldVal === undefined) {
            // Ignore the initialization step
            return;
          }
          // Handle actual changes not part of initialization
          this._handleChange();
        },

        _observeSelectedDnsOne: function(newVal, oldVal) {
          if (oldVal === null || oldVal === undefined) {
            // Ignore the initialization step
            return;
          }

          // Handle actual changes not part of initialization
          this._handleChange();
        },

        _observeSelectedDnsTwo: function(newVal, oldVal) {
          if (oldVal === null || oldVal === undefined) {
            // Ignore the initialization step
            return;
          }

          // Handle actual changes not part of initialization
          this._handleChange();
        },

        _observeSelectedGateway: function(newVal, oldVal) {
          if (oldVal === null || oldVal === undefined) {
            // Ignore the initialization step
            return;
          }

          // Handle actual changes not part of initialization
          this._handleChange();
        },

        _computeIsInputDisabled(mode) {
          debug('_computeIsInputDisabled', mode);
          return mode !== MODES.STATIC && mode !== MODES.SHARED;
        },

        _computeIsInputDisabledStatic(mode) {
          return mode !== MODES.STATIC;
        },

        _finalize: function() {
          debug('_finalize', this.config);
          // We always set the mode so we can do this before the switch
          this.config.mode = this.selectedMode;
          switch (this.selectedMode) {
            case MODES.NONE:
              this.config.address = null;
              this.config.subnet = null;
              this.config.dnsOne = null;
              this.config.dnsTwo = null;
              this.config.gateway = null;
              break;
            case MODES.DHCP:
              this.config.address = null;
              this.config.subnet = null;
              this.config.dnsOne = null;
              this.config.dnsTwo = null;
              this.config.gateway = null;
              break;
            case MODES.DHCP:
              this.config.address = null;
              this.config.subnet = null;
              this.config.dnsOne = null;
              this.config.dnsTwo = null;
              this.config.gateway = null;
              break;
            case MODES.STATIC:
              this.config.address = this.selectedAddress;
              this.config.subnet = this.selectedSubnet;
              this.config.dnsOne = null;
              this.config.dnsTwo = null;
              this.config.gateway = null;
              break;
            case MODES.SHARED:
              this.config.address = this.selectedAddress;
              this.config.subnet = this.selectedSubnet;
              this.config.dnsOne = this.selectedDnsOne;
              this.config.dnsTwo = this.selectedDnsTwo;
              this.config.gateway = this.selectedGateway;
              break;
            case MODES.BRIDGE:
              this.config.address = null;
              this.config.subnet = null;
              this.config.dnsOne = null;
              this.config.dnsTwo = null;
              this.config.gateway = null;
              break;
            default:
              // TODO error out or something since we don't know what mode this is
              console.error('Cannot finalize with unknown mode!');
              break;
          }
        },

        clear: function() {
          this._initialize(this.config);
          this.set('isChange', false);
        },

        save: function() {
          this._finalize();
          // This event will go up to the containing element which should have the MessageCenter
          this.fire('save-ethernet-config', this.config);
        }

      }); // End Polymer
})();
  </script>

</dom-module>
